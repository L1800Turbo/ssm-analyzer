{
  "version": "0.1",
  "static_rom_pattern": [
    {
      "name": "wait_ms",
      "pattern": [
        { "mnemonic": "pshx" },
        { "max_skip": 3 },
        { "mnemonic": "ldx" },
        { "mnemonic": "jsr", "op_str": "FN{mul16bit}" },
        { "mnemonic": "ldd" },
        { "mnemonic": "jsr", "op_str": "FN{divide}" }
      ]
    },
    {
      "name": "divide",
      "start_address": "REF{divide}",
      "pattern": [
        { "mnemonic": "ldx" },
        { "mnemonic": "std" },
        { "mnemonic": "clra" },
        { "mnemonic": "clrb" },
        { "mnemonic": "asl" },
        { "mnemonic": "rol", "op_str": "VAR{print_hex_buffer_2}" },
        { "mnemonic": "rol", "op_str": "VAR{print_hex_buffer_1}" },
        { "mnemonic": "rol", "op_str": "VAR{print_hex_buffer_0}" }
      ]
    },
    {
      "name": "select_system",
      "depends_on": ["wait_ms"],
      "pattern": [
        { "mnemonic": "ldx", "op_str": "REF{str_select_system}" },
        { "mnemonic": "jsr", "op_str": "FN{set_upper_screen_buffer}" },
        { "mnemonic": "jsr", "op_str": "FN{print_upper_screen}" },
        { "mnemonic": "ldaa", "op_str": "VAR{current_selected_device}" },
        { "max_skip": 13, "min_skip": [10] },
        { "mnemonic": "mul" },
        { "mnemonic": "abx" },
        { "mnemonic": "jsr", "op_str": "FN{copy_to_lower_screen_buffer}" },
        { "mnemonic": "jsr", "op_str": "FN{set_display_only_no_cursor}" },
        { "mnemonic": "jsr", "op_str": "FN{print_lower_screen}" }
      ],
      "description": "SELECT SYSTEM Function"
    },
    {
      "name": "set_display_only_no_cursor",
      "depends_on": ["select_system"],
      "start_address": "REF{set_display_only_no_cursor}",
      "pattern": [
        { "mnemonic": "psha" },
        { "mnemonic": "ldaa", "op_str": "VAR{blink_cursor_flag}" },
        { "mnemonic": "anda", "op_str": "#$FE" },
        { "mnemonic": "staa", "op_str": "VAR{blink_cursor_flag}" },
        { "mnemonic": "pula" },
        { "mnemonic": "rts" }
      ]
    },
    {
      "name": "set_upper_screen_buffer",
      "depends_on": ["select_system"],
      "start_address": "REF{set_upper_screen_buffer}",
      "pattern": [
        { "mnemonic": "psha" },
        { "mnemonic": "pshb" },
        { "mnemonic": "pshx" },
        { "mnemonic": "stx" },
        { "mnemonic": "ldab", "op_str": 0 },
        { "mnemonic": "ldx" },
        { "mnemonic": "abx"},
        { "mnemonic": "ldaa" },
        { "mnemonic": "ldx", "op_str": "VAR{ssm_display_y0_x0}" }
      ],
      "additional_vars": {
        "VAR{ssm_display_y0_x1}": "REF{ssm_display_y0_x0}+1",
        "VAR{ssm_display_y0_x2}": "REF{ssm_display_y0_x0}+2",
        "VAR{ssm_display_y0_x3}": "REF{ssm_display_y0_x0}+3",
        "VAR{ssm_display_y0_x4}": "REF{ssm_display_y0_x0}+4",
        "VAR{ssm_display_y0_x5}": "REF{ssm_display_y0_x0}+5",
        "VAR{ssm_display_y0_x6}": "REF{ssm_display_y0_x0}+6",
        "VAR{ssm_display_y0_x7}": "REF{ssm_display_y0_x0}+7",
        "VAR{ssm_display_y0_x8}": "REF{ssm_display_y0_x0}+8",
        "VAR{ssm_display_y0_x9}": "REF{ssm_display_y0_x0}+9",
        "VAR{ssm_display_y0_x10}": "REF{ssm_display_y0_x0}+10",
        "VAR{ssm_display_y0_x11}": "REF{ssm_display_y0_x0}+11",
        "VAR{ssm_display_y0_x12}": "REF{ssm_display_y0_x0}+12",
        "VAR{ssm_display_y0_x13}": "REF{ssm_display_y0_x0}+13",
        "VAR{ssm_display_y0_x14}": "REF{ssm_display_y0_x0}+14",
        "VAR{ssm_display_y0_x15}": "REF{ssm_display_y0_x0}+15",

        "VAR{ssm_display_y1_x0}": "REF{ssm_display_y0_x0}+16",

        "VAR{ssm_display_y1_x1}": "REF{ssm_display_y1_x0}+1",
        "VAR{ssm_display_y1_x2}": "REF{ssm_display_y1_x0}+2",
        "VAR{ssm_display_y1_x3}": "REF{ssm_display_y1_x0}+3",
        "VAR{ssm_display_y1_x4}": "REF{ssm_display_y1_x0}+4",
        "VAR{ssm_display_y1_x5}": "REF{ssm_display_y1_x0}+5",
        "VAR{ssm_display_y1_x6}": "REF{ssm_display_y1_x0}+6",
        "VAR{ssm_display_y1_x7}": "REF{ssm_display_y1_x0}+7",
        "VAR{ssm_display_y1_x8}": "REF{ssm_display_y1_x0}+8",
        "VAR{ssm_display_y1_x9}": "REF{ssm_display_y1_x0}+9",
        "VAR{ssm_display_y1_x10}": "REF{ssm_display_y1_x0}+10",
        "VAR{ssm_display_y1_x11}": "REF{ssm_display_y1_x0}+11",
        "VAR{ssm_display_y1_x12}": "REF{ssm_display_y1_x0}+12",
        "VAR{ssm_display_y1_x13}": "REF{ssm_display_y1_x0}+13",
        "VAR{ssm_display_y1_x14}": "REF{ssm_display_y1_x0}+14",
        "VAR{ssm_display_y1_x15}": "REF{ssm_display_y1_x0}+15"

      }
    },
    {
      "name": "attach_ssm_comm_type",
      "depends_on": ["set_upper_screen_buffer"],
      "pattern": [
        { "mnemonic": "clr",  "op_str": "VAR{no_success_on_first_connection_flag}" },
        { "max_skip": 1 },
        { "mnemonic": "ldaa", "op_str": "REF{current_selected_device}" },
        { "mnemonic": "bita" },
        { "mnemonic": ["beq", "bne"]},
        { "max_skip": 2 },
        { "mnemonic": "ldab"},
        { "mnemonic": "stab", "op_str": "VAR{current_ssm_protocol_version}" },
        { "mnemonic": "ldx"},
        { "mnemonic": "lsra" },
        { "mnemonic": "bcs" },
        { "mnemonic": "inx" },
        { "mnemonic": "bra"},
        { "mnemonic": "ldab", "op_str": 0 },
        { "mnemonic": "stab", "op_str": "VAR{current_ssm_cmd}" }
      ],
      "description": "fn_attach_ssm_cmd_commType: setzt anhand des aktuellen Gerätes den SSM-Protokolltyp und initialisiert die Befehls-Tabelle."
    },
    {
      "name": "set_communication_protocol",
      "depends_on": ["attach_ssm_comm_type"],
      "pattern": [
        { "mnemonic": "ldaa", "op_str": "REF{current_ssm_protocol_version}" },
        { "mnemonic": "cmpa", "op_str": 2 },
        { "mnemonic": "beq" },
        { "mnemonic": "jsr" },
        { "mnemonic": "jsr" }
      ]
    },
    {
        "name": "set_address_offsets",
        "depends_on": ["set_communication_protocol"],
        "pattern": [
            {"mnemonic": "ldab", "op_str": "REF{PORT5}"},
            {"mnemonic": "andb", "op_str": "0xFB" },
            {"mnemonic": "stab", "op_str": "REF{PORT5}"},
            {"mnemonic": "ldab", "op_str": "REF{PORT6}"},
            {"mnemonic": "andb", "op_str": "0x7F"},
            {"mnemonic": "stab", "op_str": "REF{PORT6}"},
            {"mnemonic": "ldaa", "op_str": "REF{current_selected_device}"}
        ]
    },
    {
        "name": "attach_romid_table_ptr",
        "depends_on": ["set_address_offsets"],
        "pattern": [
            {"mnemonic": "ldaa", "op_str": "REF{current_selected_device}"},
            {"mnemonic": "cmpa" },
            {"mnemonic": "bne" },
            {"mnemonic": "ldx" },
            {"mnemonic": "stx", "op_str": "VAR{romid_table_ptr}"},
            {"mnemonic": "ldab" },
            {"mnemonic": "stab", "op_str": "VAR{romid_table_max_index}"}
        ]
    },
    {
      "name": "attempt_communication_set_SSM_tx_bytes",
      "depends_on": ["attach_romid_table_ptr"],
      "pattern": [
        { "mnemonic": "sei" },
        { "mnemonic": "ldd" },
        { "mnemonic": "std",  "op_str": "VAR{ssm_rx_byte_0}" },
        { "mnemonic": "ldaa", "op_str": "REF{current_ssm_cmd}" },
        { "mnemonic": "staa", "op_str": "VAR{ssm_tx_byte_0}" },
        { "mnemonic": "ldd" },
        { "mnemonic": "std",  "op_str": "VAR{ssm_tx_byte_1}" },
        { "mnemonic": "ldab", "op_str": "REF{current_selected_device}" }
      ],
      "additional_vars": {
        "VAR{ssm_tx_byte_2}": "REF{ssm_tx_byte_1}+1",
        "VAR{ssm_tx_byte_3}": "REF{ssm_tx_byte_2}+1",
        "VAR{ssm_rx_byte_1}": "REF{ssm_rx_byte_0}+1",
        "VAR{ssm_rx_byte_2}": "REF{ssm_rx_byte_1}+1"
      },
      "description": "attempt_communication_set_SSM_tx_bytes: setzt die ersten Bytes für den SSM-Transfer (rx=FFFF, tx[0]=current_ssm_cmd, tx[1]=0x8000, Auswahl anhand current_selected_device)."
    },
    {
      "name": "attempt_communication_set_SSM_tx_bytes_loopPart",
      "depends_on": ["attempt_communication_set_SSM_tx_bytes"],
      "pattern": [
        { "mnemonic": "tst", "op_str": "VAR{ssm_receive_status}" },
        { "mnemonic": "beq" },
        { "mnemonic": "ldx", "op_str": "REF{ssm_rx_byte_0}" },
        { "mnemonic": "cpx", "op_str": "REF{ssm_tx_byte_1}" },
        { "mnemonic": "bne" }
      ],
      "start_address": "REF{attempt_communication_set_SSM_tx_bytes}"
    },
    {
      "name": "request_romid_save_romid",
      "depends_on": ["attempt_communication_set_SSM_tx_bytes_loopPart"],
      "pattern": [
        { "mnemonic": "sei" },
        { "mnemonic": "ldd" },
        { "mnemonic": "std",  "op_str": "REF{ssm_rx_byte_0}" },
        { "mnemonic": "staa", "op_str": "REF{ssm_rx_byte_2}" },
        { "mnemonic": "ldaa", "op_str": "VAR{ssm_ask_romid_cmd}" },
        { "mnemonic": "staa", "op_str": "REF{ssm_tx_byte_0}" },
        { "mnemonic": "ldd" },
        { "mnemonic": "std",  "op_str": "REF{ssm_tx_byte_1}" },
        { "mnemonic": "ldab", "op_str": "REF{current_selected_device}" }
      ],
      "description": "request_romid_save_romid"
    },
    {
      "name": "search_matching_romid_96",
      "depends_on": ["request_romid_save_romid"],
      "replaces": ["search_matching_romid_97"],
      "pattern": [
        { "mnemonic": "ldx", "op_str": "REF{romid_table_ptr}" },
        { "mnemonic": "clr" },
        { "mnemonic": "clr", "op_str": "VAR{romid_EGi_Axxx_scheme}" },
        { "mnemonic": "ldaa", "op_str": "REF{current_selected_device}" }
      ],
      "description": ""
    },
    {
      "name": "search_matching_romid_97",
      "depends_on": ["request_romid_save_romid"],
      "replaces": ["search_matching_romid_96"],
      "pattern": [
        { "mnemonic": "ldx", "op_str": "REF{romid_table_ptr}" },
        { "mnemonic": "clr" },
        { "mnemonic": "clr", "op_str": "VAR{romid_EGi_Axxx_scheme}" },
        { "mnemonic": "clr", "op_str": "VAR{romid_AT_Axxx_scheme}" },
        { "mnemonic": "ldaa", "op_str": "REF{current_selected_device}" }
      ],
      "description": "Special pattern for 1997 ROMs"
    },
    {
      "name": "search_matching_romid_part",
      "depends_on": ["search_matching_romid_96", "search_matching_romid_97"],
      "pattern": [
        { "mnemonic": "pulx" },
        { "mnemonic": "stx",  "op_str": "VAR{current_romid_line_pointer}" },
        { "mnemonic": "ldd",  "op_str": "VAR{romid_0}" },
        { "mnemonic": "std",  "op_str": "VAR{romid_0_2}" }
      ],
      "additional_vars": {
        "VAR{romid_1}": "REF{romid_0}+1",
        "VAR{romid_1_2}": "REF{romid_0_2}+1",
        "VAR{romid_2}": "REF{romid_1}+1",
        "VAR{romid_2_2}": "REF{romid_1_2}+1"
      },
      "description": "Small pattern of the RomID check part, comes up several times to find the RomID variables TODO Startadresse geht nicht"
    },
    {
      "name": "set_current_romid_values",
      "depends_on": ["search_matching_romid_part"],
      "pattern": [
        { "mnemonic": "ldx",  "op_str": "REF{current_romid_line_pointer}" },
        { "max_skip": 19, "min_skip": [0, 10] },
        { "mnemonic": "ldd",  "op_str": "0x03" },
        { "mnemonic": "staa", "op_str": "VAR{current_romid_scaling_index}" },
        { "mnemonic": "stab", "op_str": "VAR{current_romid_label_index}" },
        { "mnemonic": "ldaa", "op_str": "0x05" },
        { "mnemonic": "staa", "op_str": "VAR{current_romid_menuitems_Index}" },
        { "mnemonic": "ldd",  "op_str": "0x08" },
        { "mnemonic": "std",  "op_str": "VAR{current_romid_mastertable_address}" },
        { "mnemonic": "ldd",  "op_str": "0x0A" },
        { "mnemonic": "staa", "op_str": "VAR{current_romid_a}" },
        { "mnemonic": "stab", "op_str": "VAR{current_romid_b}" },
        { "mnemonic": "ldd",  "op_str": "0x0C" },
        { "mnemonic": "staa", "op_str": "VAR{current_romid_model_index}" },
        { "mnemonic": "stab", "op_str": "VAR{current_romid_flagcmd}" },
        { "mnemonic": "ldx",  "op_str": "0x06" }
      ]
    },
    {
      "name": "attach_cu_specific_addresses",
      "depends_on": ["set_current_romid_values"],
      "pattern": [
        { "mnemonic": "ldab", "op_str": "0xFF" },
        { "mnemonic": "stab", "op_str": "VAR{maximum_menuitem_index_2}" },
        { "mnemonic": "stab", "op_str": "VAR{last_visible_menuitem_index}" },
        { "mnemonic": "ldaa", "op_str": "REF{current_selected_device}" },
        { "mnemonic": "cmpa" },
        { "max_skip": 4, "min_skip": [3]},
        { "mnemonic": "ldaa" },
        { "mnemonic": "staa", "op_str": "VAR{max_length_menuitems_1}" },
        { "mnemonic": "staa", "op_str": "VAR{max_length_menuitems_2}" },
        { "mnemonic": "ldaa" },
        { "mnemonic": "staa", "op_str": "VAR{max_length_hidden_menuitems}" },
        { "mnemonic": "ldx" },
        { "mnemonic": "stx", "op_str": "VAR{temporary_menuitems_pointer}" },
        { "mnemonic": "ldx" },
        { "mnemonic": "stx", "op_str": "VAR{possible_hidden_menuitems_pointer}" },
        { "mnemonic": "ldx" },
        { "mnemonic": "stx", "op_str": "VAR{menuitems_upper_label_pointer}" },
        { "mnemonic": "ldx" },
        { "mnemonic": "stx", "op_str": "VAR{adjustments_label_pointer}" },
        { "mnemonic": "ldx" },
        { "mnemonic": "stx", "op_str": "VAR{current_scale_fn_table_pointer}" },
        { "mnemonic": "ldx" },
        { "mnemonic": "stx", "op_str": "VAR{menuitems_lower_label_pointer}" },
        { "mnemonic": "ldx" },
        { "mnemonic": "stx", "op_str": "VAR{romid_upper_label_pointer}" },
        { "mnemonic": "ldx" },
        { "mnemonic": "stx", "op_str": "VAR{romid_lower_label_pointer}" }
      ],
      "description": "Skip is unclear yet for other cassettes"
    },
    {
      "name": "set_maximum_menuitem_and_hidden_menuitem_indexes",
      "depends_on": ["attach_cu_specific_addresses"],
      "start_address": "REF{attach_cu_specific_addresses}",
      "pattern": [
        { "mnemonic": "clr", "op_str": "VAR{maximum_menuitem_index_1}"},
        { "mnemonic": "jsr", "op_str": "FN{set_current_pointer_possible_menuitems}"},
        { "mnemonic": "stx", "op_str": "VAR{final_menuitems_pointer}"},
        { "mnemonic": "ldab", "op_str": "REF{max_length_menuitems_1}"}
      ],
      "description": "IMPREZA96 @0x8AD4"
    },
    {
      "name": "master_table_main_loop",
      "pattern": [
        { "mnemonic": "tst", "op_str": "VAR{IF_check_read_active}" },
        { "mnemonic": "beq" },
        { "mnemonic": "tst" },
        { "mnemonic": "bne" },
        { "mnemonic": "clr" },
        { "mnemonic": "tst" },
        { "mnemonic": "beq" },
        { "mnemonic": "ldd", "op_str": "VAR{mastertable_0_0}" },
        { "mnemonic": "std", "op_str": "VAR{mastertable_0_1}" },
        { "mnemonic": "ldd", "op_str": "VAR{mastertable_2_0}" },
        { "mnemonic": "std", "op_str": "VAR{mastertable_2_1}" }
      ],
      "description": "Main Loop where the master table is checked and the menu is running. Mainly to know when to interrupt an infinite loop"
    },
    {
      "name": "master_table_main_loop_worker_jumps",
      "depends_on": ["master_table_main_loop"],
      "pattern": [
        { "mnemonic": "ldx", "op_str": "VAR{master_table_worker_functions_ptr}" },
        { "mnemonic": "aslb" },
        { "mnemonic": "abx" },
        { "mnemonic": "ldx", "op_str": 0 },
        { "mnemonic": "bne"},
        { "mnemonic": "jmp", "op_str": "REF{master_table_main_loop}"}
      ],
      "description": "IMPREZA96 @0x8EA4: Get a list of worker function pointers which get called dynamically"
    }
  ],
  "master_table_pointer_pattern":
  [
    {
      "name": "master_table_info_into_ram",
      "depends_on": ["master_table_main_loop"],
      "pattern": [
        { "mnemonic": "tst", "op_str": "VAR{romid_A_is_0x20}" },
        { "mnemonic": "beq" },
        { "mnemonic": "jsr", "op_str": "FN{long_table_baro_mani_comms}" },
        { "mnemonic": "ldaa", "op_str": "VAR{current_master_table_index}" },
        { "mnemonic": "ldab"}
      ],
      "description": "IMPREZA96 @0x903C: Load information from the Mastertable list pointer into RAM values that'll be used in the Action fn later on"
    },
    {
      "name": "read_from_ecu",
      "pattern": [
        { "mnemonic": "clr" },
        { "mnemonic": "sei" },
        { "mnemonic": "ldd", "op_str": "0xFFFF" },
        { "mnemonic": "std", "op_str": "REF{ssm_rx_byte_0}" },
        { "mnemonic": "ldx", "op_str": "VAR{current_ecu_address}" },
        { "mnemonic": "cpx", "op_str": "0xFFFF" },
        { "mnemonic": "bne" },
        { "mnemonic": "com", "op_str": "REF{ssm_rx_byte_0}" },
        { "mnemonic": "com", "op_str": "REF{ssm_rx_byte_1}" }
      ]
    },
    {
      "name": "mastertable_run_scaling_fn",
      "depends_on": ["master_table_main_loop"],
      "pattern": [
        { "mnemonic": "ldaa", "op_str": 1 },
        { "mnemonic": "staa", "op_str": "VAR{activate_scaling_in_MT_MainLoop}" },
        { "mnemonic": "tst", "op_str": "VAR{response_received_flag}" },
        { "mnemonic": "beq" },
        { "mnemonic": "clr" },
        { "mnemonic": "ldaa", "op_str": "REF{current_ssm_protocol_version}" },
        { "mnemonic": "cmpa", "op_str": 2 },
        { "mnemonic": "beq" },
        { "max_skip": 9},
        { "mnemonic": "clr", "op_str": "VAR{master_table_run_scaling_wait_counter}" },
        { "mnemonic": "clr", "op_str": "VAR{print_-_sign}" },
        { "mnemonic": "clr", "op_str": "VAR{print_+_sign}" },
        { "mnemonic": "ldx", "op_str": "REF{current_scale_fn_table_pointer}" }
      ],
      "description": "IMPREZA96 @0xAC7B: Call scaling function from Mastertable MainLoop, TODO: clr hat response_received_flag"
    }
  ],
  "action_table_pointer_pattern":
  [
    {
      "name": "action_year",
      "pattern": [
        { "mnemonic": "staa", "op_str": "VAR{current_scaling_index}" },
        { "mnemonic": "stab", "op_str": "VAR{current_ecu_address_index}" },
        { "mnemonic": "ldd",	 "op_str": "0x012C" },
        { "mnemonic": "jsr",  "op_str": "REF{wait_ms}" },
        { "mnemonic": "tst",  "op_str": "REF{romid_EGi_Axxx_scheme}" }, 
        { "mnemonic": "beq" },
        { "mnemonic": "ldx" }
      ],
      "description": "IMPREZA96 @0x95E9: Action for YEAR function, print model year and ECU version to screen"
    },
    {
      "name": "action_read_ecu",
      "pattern": [
        { "mnemonic": "staa", "op_str": "REF{current_scaling_index}" },
        { "mnemonic": "ldaa", "op_str": "0x01" },
        { "mnemonic": "staa", "op_str": "REF{IF_check_read_active}" },
        { "mnemonic": "stab", "op_str": "REF{current_ecu_address_index}" },
        { "mnemonic": "jsr",  "op_str": "FN{set_current_ecu_address}" },
        { "mnemonic": "jsr",  "op_str": "FN{read_from_ecu}" },
        { "mnemonic": "bcs"}
      ],
      "description": "IMPREZA96 @0x96A9: Action for READ CU function"
    }
  ],
  "scaling_function_pattern":
  [
    {
      "name": "print_lower_value",
      "pattern": [
        { "mnemonic": "jsr" },
        { "mnemonic": "jsr", "op_str": "FN{hex2ascii}" },
        { "mnemonic": "tst", "op_str": "VAR{decimal_places}" },
        { "mnemonic": "bne" },
        { "mnemonic": "jsr" },
        { "mnemonic": "bra" }
      ],
      "description": ""
    },
    {
      "name": "print_switch_screen",
      "pattern": [
        { "mnemonic": "ldab", "op_str": "REF{current_romid_scaling_index}" },
        { "mnemonic": "decb" },
        { "mnemonic": "ldaa" },
        { "mnemonic": "mul" },
        { "mnemonic": "abx" },
        { "mnemonic": "ldd" },
        { "mnemonic": "xgdx" },
        { "mnemonic": "jsr", "op_str": "REF{set_upper_screen_buffer}" },
        { "mnemonic": "jsr", "op_str": "REF{print_upper_screen}" }
      ],
      "description": "IMPREZA96 @0x34C6: Print value to upper screen and switch screen based on RomID scaling index (RomID[3])"
    },
    {
      "name": "hex_value_to_ssm_light",
      "pattern": [
        { "mnemonic": "eora", "op_str": 0 },
        { "mnemonic": "inx" },
        { "mnemonic": "ldab", "op_str": 5 },
        { "mnemonic": "psha" }
      ],
      "description": "IMPREZA96 @0xB501: Set SSM lights based on hex value, usually used for switches"
    }
  ],
  "strings": {
    "str_select_system": " SELECT SYSTEM  "
  }
}
